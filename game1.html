<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Avoid the Bomb</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    /* Layout bits just for this page */
    #gameTitle {
      font-family: 'Press Start 2P', cursive;
      font-size: 14px; text-align: center; color: #ff8800; margin: 20px 0 10px;
    }
    #gameArea {
      position: relative; margin: 0 auto 20px; width: 300px; height: 400px;
      border: 4px solid #000; border-radius: 8px; background: linear-gradient(#d6f0ff, #ffffff);
      overflow: hidden; touch-action: none;
    }
    #scoreBoard {
      position: absolute; top: 5px; left: 5px;
      font-family: 'Press Start 2P', cursive; font-size: 12px;
      background: #fff; border: 2px solid #000; padding: 4px 6px;
    }

    /* Sprites (fixed sizes) */
    .sprite { position: absolute; user-select: none; pointer-events: none; }
    #player.sprite { width: 32px; height: 32px; bottom: 10px; left: 134px; }
    .falling.sprite { width: 28px; height: 28px; top: -30px; }

    /* Overlays */
    .overlay-modal {
      position: absolute; inset: 0; background: rgba(0,0,0,0.7); color: #fff;
      font-family: 'Press Start 2P', cursive; display: none; flex-direction: column;
      align-items: center; justify-content: center; text-align: center; padding: 20px; gap: 12px;
    }
    .pixel-btn-sm {
      padding: 10px 16px; background: #ffec61; border: 3px solid #000; border-radius: 6px;
      font-size: 12px; cursor: pointer; font-family: 'Press Start 2P', cursive; color: #111;
      box-shadow: 0 4px #000; transition: transform .15s ease, box-shadow .15s ease;
    }
    .pixel-btn-sm:active { transform: translateY(4px); box-shadow: 0 0 #000; }

    .back-wrapper { text-align:center; margin: 12px 0 26px; }
  </style>
</head>
<body class="allow-scroll">
  <main class="screen safe scroll">
    <div class="bg" aria-hidden="true"></div>
    <div class="overlay" aria-hidden="true"></div>

    <h2 id="gameTitle">AVOID THE BOMB ðŸ’£</h2>
    <div id="gameArea">
      <!-- Player -->
      <img id="player" class="sprite" alt="player">

      <!-- HUD -->
      <div id="scoreBoard">Score: 0</div>

      <!-- Game Over -->
      <div id="gameOver" class="overlay-modal">
        <div style="font-size:16px">GAME OVER</div>
        <button id="restartBtn" class="pixel-btn-sm">RESTART</button>
      </div>

      <!-- Congrats at 20 -->
      <div id="congrats" class="overlay-modal">
        <div style="font-size:14px; line-height:1.6">
          CONGRATS!<br>YOU HIT 20 ðŸŽ‰
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
          <button id="continueBtn" class="pixel-btn-sm">CONTINUE</button>
          <a id="nextBtn" class="pixel-btn-sm" href="#">NEXT PAGE</a>
        </div>
      </div>
    </div>

    <!-- BACK is now below the game -->
    <div class="back-wrapper">
      <a href="menu.html" class="pixel-btn">BACK</a>
    </div>
  </main>

  <script>
    /* ========= CONFIG ========= */
    const SPRITES = {
      player: 'assets/logo/esteh.png', // change to your image
      heart:  'assets/logo/heart.png',        // change to your image
      bomb:   'assets/logo/baba.png'          // change to your image
    };
    const NEXT_PAGE = 'menu.html'; // change target if needed

    /* ========= DOM ========= */
    const gameArea        = document.getElementById('gameArea');
    const playerEl        = document.getElementById('player');
    const scoreBoard      = document.getElementById('scoreBoard');
    const gameOverScreen  = document.getElementById('gameOver');
    const restartBtn      = document.getElementById('restartBtn');
    const congratsScreen  = document.getElementById('congrats');
    const continueBtn     = document.getElementById('continueBtn');
    const nextBtn         = document.getElementById('nextBtn');

    playerEl.src = SPRITES.player;
    nextBtn.href = NEXT_PAGE;

    /* ========= STATE ========= */
    const GAME_W      = 300;
    const PLAYER_W    = 32;
    const ITEM_W      = 28;

    let score         = 0;
    let playerX       = (GAME_W - PLAYER_W) / 2;
    let playing       = true;
    let paused        = false;
    let speed         = 2.8;   // px/frame
    let spawnMin      = 600;   // ms
    let spawnMax      = 1200;  // ms
    let speedTimerId  = null;
    let spawnTimerId  = null;
    let items         = new Set();
    let rafId         = null;
    let hit20Shown    = false;

    playerEl.style.left = playerX + 'px';

    /* ========= INPUT ========= */
    function moveToClientX(clientX) {
      const rect = gameArea.getBoundingClientRect();
      const x = clientX - rect.left;
      playerX = Math.max(0, Math.min(GAME_W - PLAYER_W, x - PLAYER_W / 2));
      playerEl.style.left = playerX + 'px';
    }
    gameArea.addEventListener('touchmove', (e) => {
      if (!playing || paused) return;
      moveToClientX(e.touches[0].clientX);
    }, {passive:true});
    gameArea.addEventListener('mousemove', (e) => {
      if (!playing || paused) return;
      moveToClientX(e.clientX);
    });

    /* ========= SPAWN ========= */
    function scheduleSpawn() {
      // ensure any pending spawn is cleared first
      if (spawnTimerId) { clearTimeout(spawnTimerId); spawnTimerId = null; }
      if (!playing || paused) return;
      const delay = Math.max(200, rand(spawnMin, spawnMax));
      spawnTimerId = setTimeout(() => {
        if (playing && !paused) spawnItem();
        scheduleSpawn(); // chain next spawn
      }, delay);
    }

    function spawnItem() {
      const isHeart = Math.random() < 0.7; // 70% heart, 30% bomb
      const el = document.createElement('img');
      el.className = 'falling sprite';
      el.src = isHeart ? SPRITES.heart : SPRITES.bomb;
      el.alt = isHeart ? 'heart' : 'bomb';
      el.style.left = (Math.random() * (GAME_W - ITEM_W)) + 'px';
      el.dataset.type = isHeart ? 'heart' : 'bomb';
      el.dataset.top = '-30';
      gameArea.appendChild(el);
      items.add(el);
    }

    /* ========= LOOP ========= */
    function loop() {
      if (!playing) return;
      if (!paused) updateItems();
      rafId = requestAnimationFrame(loop);
    }

    function updateItems() {
      items.forEach((el) => {
        let top = parseFloat(el.dataset.top);
        top += speed;
        el.dataset.top = String(top);
        el.style.top = top + 'px';

        // collision band with player
        if (top > 360 && top < 390) {
          const itemX = parseFloat(el.style.left);
          if (itemX < playerX + PLAYER_W && itemX + ITEM_W > playerX) {
            if (el.dataset.type === 'heart') {
              score++;
              scoreBoard.textContent = 'Score: ' + score;
              if (score >= 20 && !hit20Shown) {
                hit20Shown = true;
                pauseForCongrats();
              }
            } else {
              endGame();
            }
            cleanupItem(el);
          }
        }
        if (top > 420) cleanupItem(el);
      });
    }

    function cleanupItem(el) { items.delete(el); el.remove(); }

    /* ========= DIFFICULTY (every 3s) ========= */
    function startDifficultyRamp() {
      // clear then start to avoid double intervals
      if (speedTimerId) { clearInterval(speedTimerId); speedTimerId = null; }
      speedTimerId = setInterval(() => {
        speed    = Math.min(speed + 0.35, 8);
        spawnMin = Math.max(spawnMin - 40, 260);
        spawnMax = Math.max(spawnMax - 60, 520);
      }, 3000);
    }

    /* ========= MODALS ========= */
    function pauseForCongrats() {
      paused = true;
      congratsScreen.style.display = 'flex';
      // spawns stop while paused; when resuming, reschedule explicitly
    }

    continueBtn?.addEventListener('click', () => {
      congratsScreen.style.display = 'none';
      paused = false;
      scheduleSpawn();           // <<< ensure spawns resume
      if (!speedTimerId) startDifficultyRamp();
    });

    function endGame() {
      playing = false;
      clearTimers();
      congratsScreen.style.display = 'none';
      gameOverScreen.style.display = 'flex';
    }

    restartBtn?.addEventListener('click', () => {
      // reset core state
      score = 0; scoreBoard.textContent = 'Score: 0';
      playerX = (GAME_W - PLAYER_W) / 2; playerEl.style.left = playerX + 'px';
      speed = 2.8; spawnMin = 600; spawnMax = 1200;
      hit20Shown = false; paused = false; playing = true;

      // clear items
      items.forEach(el => el.remove());
      items.clear();

      // hide overlays
      gameOverScreen.style.display = 'none';
      congratsScreen.style.display = 'none';

      // fully restart timers/loop
      clearTimers();
      scheduleSpawn();           // <<< restart spawns
      startDifficultyRamp();     // <<< restart difficulty ramp
      if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
      loop();                    // <<< ensure RAF is running
    });

    function clearTimers() {
      if (spawnTimerId) { clearTimeout(spawnTimerId); spawnTimerId = null; }
      if (speedTimerId) { clearInterval(speedTimerId); speedTimerId = null; }
    }

    /* ========= Utils & Start ========= */
    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    // init
    scheduleSpawn();
    startDifficultyRamp();
    loop();
  </script>
</body>
</html>
